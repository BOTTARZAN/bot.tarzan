<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ù„Ø³Ø§Øª - Ø·Ø±Ø²Ø§Ù† Ø§Ù„ÙˆØ§Ù‚Ø¯ÙŠ</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');

    body {
        font-family: 'Cairo', sans-serif;
        background: #101820;
        color: #fff;
        margin: 0;
        text-align: center;
        direction: rtl;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    header {
        background: #1f2937;
        padding: 15px;
        font-size: 24px;
        color: #00f7ff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    main {
        padding: 20px;
        flex-grow: 1;
        max-width: 900px;
        margin: 0 auto;
        width: 90%;
    }

    input {
        padding: 12px;
        margin: 10px 8px;
        border-radius: 8px;
        border: none;
        font-size: 17px;
        width: 250px;
        max-width: 100%;
        box-sizing: border-box;
        transition: box-shadow 0.3s ease;
    }
    input:focus {
        outline: none;
        box-shadow: 0 0 8px #00f7ff;
    }

    button {
        padding: 12px 20px;
        background: #00f7ff;
        color: #101820;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
        min-width: 130px;
    }
    button:hover {
        background: #06c2d4;
    }

    table {
        width: 100%;
        margin-top: 30px;
        border-collapse: collapse;
        background: #1f2937;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 12px rgba(0,0,0,0.7);
    }

    th, td {
        padding: 14px 10px;
        border-bottom: 1px solid #333;
        word-break: break-word;
    }

    th {
        background: #00f7ff;
        color: #101820;
        font-weight: 600;
        user-select: none;
    }

    td button {
        padding: 7px 14px;
        font-size: 14px;
        user-select: none;
    }

    .status-online {
        color: #00ff00;
        font-weight: bold;
    }

    .status-offline {
        color: #ff3c3c;
        font-weight: bold;
    }

    .pair-code {
        margin-top: 15px;
        font-size: 20px;
        font-weight: bold;
        color: #00f7ff;
        background: rgba(0, 247, 255, 0.15);
        padding: 15px 20px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        animation: fadeInScale 0.5s ease forwards;
        user-select: text;
        white-space: nowrap;
    }

    .copy-btn {
        background: #06c2d4;
        color: #101820;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.3s ease;
        user-select: none;
    }
    .copy-btn:hover {
        background: #00f7ff;
    }

    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.85);}
        to { opacity: 1; transform: scale(1);}
    }

    /* Responsive */
    @media (max-width: 600px) {
        input {
            width: 100%;
            margin: 10px 0;
        }
        button {
            width: 100%;
            min-width: unset;
            margin-top: 8px;
        }
        table, th, td {
            font-size: 14px;
        }
        main {
            padding: 15px 10px;
        }
    }
</style>
</head>
<body>
<header>
    <h1>ğŸ”¥ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ù„Ø³Ø§Øª - Ø·Ø±Ø²Ø§Ù† Ø§Ù„ÙˆØ§Ù‚Ø¯ÙŠ</h1>
</header>

<main>
    <section class="add-session">
        <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <input type="text" id="sessionId" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©" autocomplete="off" />
        <input type="text" id="phoneNumber" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ" autocomplete="off" />
        <button onclick="createSession()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        <div id="pairCode" class="pair-code" style="display:none;"></div>
    </section>

    <section class="sessions">
        <h2>ğŸ“‹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
                    <th>ØªØ­ÙƒÙ…</th>
                </tr>
            </thead>
            <tbody id="sessionsTable"></tbody>
        </table>
    </section>
</main>

<script>
async function fetchSessions() {
    try {
        const res = await fetch('/sessions');
        const sessions = await res.json();
        const tbody = document.getElementById('sessionsTable');
        tbody.innerHTML = '';

        sessions.forEach(session => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${session.id}</td>
                <td class="${session.connected ? 'status-online' : 'status-offline'}">
                    ${session.connected ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'}
                </td>
                <td>${session.lastActive}</td>
                <td>
                    <button onclick="deleteSession('${session.id}')">ğŸ—‘ Ø­Ø°Ù</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø§Øª:', e);
    }
}

async function createSession() {
    const sessionId = document.getElementById('sessionId').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const pairCodeDiv = document.getElementById('pairCode');

    if (!sessionId || !phoneNumber) {
        alert('âŒ Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
        return;
    }

    pairCodeDiv.style.display = 'block';
    pairCodeDiv.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø²...";

    try {
        const res = await fetch('/pair', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ number: phoneNumber, sessionId })
        });
        const data = await res.json();

        if (data.pairingCode) {
            pairCodeDiv.innerHTML = `
                âœ… Ø±Ù…Ø² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ù†: <span style="color: yellow;">${data.pairingCode}</span>
                <button class="copy-btn" onclick="copyPairCode('${data.pairingCode}')">Ù†Ø³Ø®</button>
            `;
            playSound();
        } else if (data.error) {
            pairCodeDiv.textContent = `âŒ Ø®Ø·Ø£: ${data.error}`;
        } else {
            pairCodeDiv.textContent = 'âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©';
        }
    } catch (err) {
        pairCodeDiv.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
        console.error('Ø®Ø·Ø£ ÙÙŠ createSession:', err);
    }

    fetchSessions();
}

function copyPairCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        alert('ØªÙ… Ù†Ø³Ø® Ø±Ù…Ø² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ù†!');
    }).catch(() => {
        alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.');
    });
}

async function deleteSession(sessionId) {
    const password = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©');
    if (!password) return;

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© "${sessionId}"ØŸ`)) return;

    try {
        const res = await fetch('/delete-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password, sessionId })
        });
        const data = await res.json();
        alert(data.message || data.error);
        fetchSessions();
    } catch (e) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©');
        console.error('Ø®Ø·Ø£ ÙÙŠ deleteSession:', e);
    }
}

function playSound() {
    const audio = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_86f3996a9a.mp3');
    audio.play().catch(() => { /* ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª */ });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
setInterval(fetchSessions, 5000);
fetchSessions();
</script>
</body>
</html>
