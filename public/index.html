<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>لوحة تحكم الجلسات - طرزان الواقدي</title>
<style>
    body {
        font-family: 'Cairo', sans-serif;
        background: #101820;
        color: #fff;
        margin: 0;
        text-align: center;
        direction: rtl;
    }

    header {
        background: #1f2937;
        padding: 15px;
        font-size: 22px;
        color: #00f7ff;
    }

    main {
        padding: 20px;
    }

    input {
        padding: 10px;
        margin: 8px;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        width: 250px;
    }

    button {
        padding: 10px 15px;
        background: #00f7ff;
        color: #101820;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    button:hover {
        background: #06c2d4;
    }

    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background: #1f2937;
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid #333;
    }

    th {
        background: #00f7ff;
        color: #101820;
    }

    td button {
        padding: 6px 12px;
        font-size: 14px;
    }

    .status-online {
        color: #00ff00;
        font-weight: bold;
    }

    .status-offline {
        color: #ff3c3c;
        font-weight: bold;
    }

    .pair-code {
        margin-top: 10px;
        font-size: 18px;
        color: #00f7ff;
        font-weight: bold;
    }
</style>
</head>
<body>
<header>
    <h1>🔥 لوحة تحكم الجلسات - طرزان الواقدي</h1>
</header>

<main>
    <section class="add-session">
        <h2>➕ إضافة جلسة جديدة</h2>
        <input type="text" id="sessionId" placeholder="معرف الجلسة">
        <input type="text" id="phoneNumber" placeholder="رقم واتساب مع الكود الدولي">
        <button onclick="createSession()">إنشاء الجلسة</button>
        <div id="pairCode" class="pair-code"></div>
    </section>

    <section class="sessions">
        <h2>📋 الجلسات الحالية</h2>
        <table>
            <thead>
                <tr>
                    <th>المعرف</th>
                    <th>الحالة</th>
                    <th>آخر نشاط</th>
                    <th>تحكم</th>
                </tr>
            </thead>
            <tbody id="sessionsTable"></tbody>
        </table>
    </section>
</main>

<script>
async function fetchSessions() {
    const res = await fetch('/sessions');
    const sessions = await res.json();
    const tbody = document.getElementById('sessionsTable');
    tbody.innerHTML = '';

    sessions.forEach(session => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${session.id}</td>
            <td class="${session.connected ? 'status-online' : 'status-offline'}">
                ${session.connected ? '✅ متصل' : '❌ غير متصل'}
            </td>
            <td>${session.lastActive}</td>
            <td>
                <button onclick="deleteSession('${session.id}')">🗑 حذف</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function createSession() {
    const sessionId = document.getElementById('sessionId').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const pairCodeDiv = document.getElementById('pairCode');

    if (!sessionId || !phoneNumber) {
        alert('❌ أدخل معرف الجلسة ورقم الهاتف');
        return;
    }

    pairCodeDiv.innerHTML = "⏳ جاري إنشاء الرمز...";
    const res = await fetch('/pair', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number: phoneNumber, sessionId })
    });

    const data = await res.json();
    if (data.pairingCode) {
        pairCodeDiv.innerHTML = `✅ رمز الاقتران: <span style="color: yellow;">${data.pairingCode}</span>`;
        playSound();
    } else {
        pairCodeDiv.innerHTML = '❌ فشل إنشاء الجلسة';
    }

    fetchSessions();
}

async function deleteSession(sessionId) {
    const password = prompt('أدخل كلمة المرور لحذف الجلسة');
    const res = await fetch('/delete-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password, sessionId })
    });
    const data = await res.json();
    alert(data.message || data.error);
    fetchSessions();
}

function playSound() {
    const audio = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_86f3996a9a.mp3');
    audio.play();
}

setInterval(fetchSessions, 5000);
fetchSessions();
</script>
</body>
</html>
